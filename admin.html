<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin 7XX ‚Äì Painel Completo</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
    body {
        background: #0d0f12;
        color: #fff;
        font-family: Arial, sans-serif;
    }
    .sidebar {
        width: 320px;
        background: #111418;
        border-right: 1px solid #2a2f36;
        height: 100vh;
        overflow-y: auto;
    }
    .chat-area {
        flex: 1;
        background: #0f1217;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .message {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 10px;
        margin-bottom: 6px;
        font-size: 15px;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .sent {
        background: #0b7dda;
        margin-left: auto;
    }
    .received {
        background: #1f242b;
        margin-right: auto;
    }
    .header {
        background: #14181d;
        padding: 16px;
        font-size: 18px;
        border-bottom: 1px solid #2a2f36;
    }
</style>

<script type="module">
/* ====================================================
        FIREBASE CONFIG
==================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
    getFirestore, collection, 
    query, where, orderBy, onSnapshot,
    or, and
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBod8YVf5pKWI98m9rRR8axokDkNMlXX-k",
    authDomain: "aviatordaniel100x.firebaseapp.com",
    databaseURL: "https://aviatordaniel100x-default-rtdb.firebaseio.com",
    projectId: "aviatordaniel100x",
    storageBucket: "aviatordaniel100x.firebasestorage.app",
    messagingSenderId: "169015417803",
    appId: "1:169015417803:web:ce4aa4f9b77d5ddb07344e",
    measurementId: "G-EES9SVSV72"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üö® URL do seu servidor Render
// CORRE√á√ÉO: Removi o prefixo 'https://' para garantir que a vari√°vel seja apenas o dom√≠nio
const API_URL = "https://daniel100x.onrender.com";


/* ====================================================
        VARI√ÅVEIS
==================================================== */
let usuarioSelecionado = null;
let unsubscribeConversas = null; 

/* ====================================================
        REENVIAR PARA TODOS
==================================================== */
window.reenviarBoasVindas = () => {
    fetch(`${API_URL}/reenviar_boasvindas`, {
        method: "POST"
    })
    .then(r => r.json())
    .then(d => {
        if (d.status === "ok") {
            alert(`Reenviado para: ${d.reenviados.join(", ")}`);
        } else {
            alert(`Erro ao reenviar: ${JSON.stringify(d)}`);
        }
    })
    .catch((error) => alert(`Erro de conex√£o ao reenviar: ${error.message}`));
};

/* ====================================================
        LISTAR USU√ÅRIOS
==================================================== */
const lista = document.getElementById("listaUsuarios");

const qUsuarios = query(collection(db, "usuarios"), orderBy("criado", "desc"));

onSnapshot(qUsuarios, (snapshot) => {
    lista.innerHTML = "";
    snapshot.forEach((doc) => {
        const u = doc.data();
        const nomeCliente = u.nome || "Sem Nome"; 

        lista.innerHTML += `
            <div onclick="selecionarUsuario('${u.numero}', '${nomeCliente}')" 
                class="p-3 border-b border-gray-800 cursor-pointer hover:bg-gray-800">
                <div class="font-bold">${nomeCliente}</div>
                <div class="text-gray-400 text-sm">${u.numero}</div>
            </div>
        `;
    });
});

/* ====================================================
        ABRIR CHAT DO USU√ÅRIO
==================================================== */
window.selecionarUsuario = (numero, nome) => {
    if (unsubscribeConversas) {
        unsubscribeConversas();
    }

    usuarioSelecionado = { numero, nome };

    document.getElementById("chatTitulo").innerText = `${nome} (${numero})`;
    document.getElementById("btnReenviarIndividual").classList.remove("hidden");

    const mensagensDiv = document.getElementById("mensagens");
    mensagensDiv.innerHTML = ""; 


const q = query(
    collection(db, "conversas"),
    or(
        and(where("numero", "==", numero), where("remetente", "==", "cliente")),
        and(where("numero_cliente", "==", numero), where("remetente", "==", "admin"))
    ),
    orderBy("horario", "asc")
);



    unsubscribeConversas = onSnapshot(q, (snapshot) => {
        mensagensDiv.innerHTML = "";

        snapshot.forEach((doc) => {
            const m = doc.data();

            mensagensDiv.innerHTML += `
                <div class="flex ${m.remetente === "admin" ? "justify-end" : "justify-start"}">
    <div class="message ${m.remetente === "admin" ? "sent" : "received"}">
        ${m.texto}
    </div>
</div>

            `;
        });

        mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
    }, (error) => {
        console.error("Erro no onSnapshot das conversas:", error);
        alert("Erro ao carregar conversas: Verifique as regras do Firebase.");
    });
};

/* ====================================================
        ENVIAR BOAS-VINDAS INDIVIDUAL (Template)
==================================================== */
window.reenviarParaUsuario = () => {
    if (!usuarioSelecionado) return;
    
    const payload = {
        numero: usuarioSelecionado.numero,
        template_name: "boas_vindas_7xx", 
        nome_usuario: usuarioSelecionado.nome 
    };

    fetch(`${API_URL}/enviar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(d => {
        if (d.ok) {
            alert(`Template 'Boas-vindas' enviado para ${usuarioSelecionado.nome}!`);
        } else {
            // CORRE√á√ÉO: Garantir que o erro da API seja extra√≠do corretamente
            alert(`Erro no envio (API): ${d.whatsapp_error ? d.whatsapp_error.error.message : (d.erro || JSON.stringify(d))}`);
        }
    })
    .catch((error) => alert(`Erro de conex√£o ao enviar template: ${error.message}`));
};

/* ====================================================
        ENVIAR MENSAGEM NORMAL (Com Debug)
==================================================== */
window.enviarMensagem = () => {
    const input = document.getElementById("inputMensagem");
    const texto = input.value.trim();

    // 1. CHECAGEM CR√çTICA
    if (!usuarioSelecionado) {
        alert("Selecione um usu√°rio primeiro.");
        return;
    }
    if (!texto) {
        alert("Digite um texto para enviar.");
        return;
    }
    
    // 2. MONTAGEM do Payload
    const payload = {
        numero: usuarioSelecionado.numero,
        texto: texto
    };

    console.log("Payload de Envio:", payload);
    console.log("URL da API:", `${API_URL}/enviar`);

    // 3. CHAMADA da API
    fetch(`${API_URL}/enviar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => {
        // Checagem de status HTTP 
        if (!r.ok) {
            return r.json().then(err => { 
                console.error("Erro na resposta do servidor:", err);
                throw new Error(err.message || JSON.stringify(err)); 
            });
        }
        return r.json();
    })
    .then(d => {
        // Sucesso
        input.value = ""; // Limpa o input
        console.log("Mensagem enviada com sucesso!", d);
    })
    .catch((error) => {
        // Falha de rede ou erro no backend
        alert(`Falha ao enviar mensagem. Causa prov√°vel: Problema de rede, CORS ou erro da API. Detalhes: ${error.message}`);
        console.error("Erro FATAL no Fetch:", error);
    });
};
</script>

</head>

<body>

<div class="flex">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="header font-bold text-xl">Usu√°rios</div>

        <!-- üî• BOT√ÉO: REENVIAR PARA TODOS -->
        <button onclick="reenviarBoasVindas()" 
                class="w-full bg-green-600 py-2 mb-2 hover:bg-green-700 rounded">
            üîÑ Reenviar Boas-Vindas (Todos)
        </button>

        <div id="listaUsuarios"></div>
    </div>

    <!-- √ÅREA DO CHAT -->
    <div class="chat-area">

        <div class="header" id="chatTitulo">Selecione um usu√°rio</div>

        <!-- üî• BOT√ÉO: REENVIAR INDIVIDUAL -->
        <button id="btnReenviarIndividual"
                onclick="reenviarParaUsuario()"
                class="bg-yellow-500 text-black px-4 py-1 m-2 rounded hover:bg-yellow-600 hidden">
            üîÅ Reenviar boas-vindas para este usu√°rio (Template)
        </button>

        <!-- MENSAGENS -->
        <div id="mensagens" class="flex-1 p-4 overflow-y-auto"></div>

        <!-- INPUT -->
        <div class="p-4 border-t border-gray-800 flex">
            <input id="inputMensagem" type="text" placeholder="Digite uma mensagem..."
                class="flex-1 bg-gray-800 p-3 rounded-lg outline-none"
                onkeydown="if(event.key === 'Enter') enviarMensagem()"> <!-- Para enviar com Enter -->
            <button onclick="enviarMensagem()" 
                class="ml-3 bg-blue-600 px-5 rounded-lg hover:bg-blue-700">
                Enviar
            </button>
        </div>

    </div>
</div>

</body>
</html>
