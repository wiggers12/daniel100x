<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin 7XX ‚Äì Painel Completo</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
    body {
        background: #0d0f12;
        color: #fff;
        font-family: Arial, sans-serif;
    }
    .sidebar {
        width: 320px;
        background: #111418;
        border-right: 1px solid #2a2f36;
        height: 100vh;
        overflow-y: auto;
    }
    .chat-area {
        flex: 1;
        background: #0f1217;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .message {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 10px;
        margin-bottom: 6px;
        font-size: 15px;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .sent {
        background: #0b7dda;
        margin-left: auto;
    }
    .received {
        background: #1f242b;
        margin-right: auto;
    }
    .header {
        background: #14181d;
        padding: 16px;
        font-size: 18px;
        border-bottom: 1px solid #2a2f36;
    }
</style>

<script type="module">
/* ====================================================
        FIREBASE CONFIG
==================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
    getFirestore, collection, query, where, 
    orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBod8YVf5pKWI98m9rRR8axokDkNMlXX-k",
    authDomain: "aviatordaniel100x.firebaseapp.com",
    databaseURL: "https://aviatordaniel100x-default-rtdb.firebaseio.com",
    projectId: "aviatordaniel100x",
    storageBucket: "aviatordaniel100x.firebasestorage.app",
    messagingSenderId: "169015417803",
    appId: "1:169015417803:web:ce4aa4f9b77d5ddb07344e",
    measurementId: "G-EES9SVSV72"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// URL do servidor Flask / Render API
const API_URL = "https://daniel100x.onrender.com";

/* ====================================================
        VARI√ÅVEIS
==================================================== */
let usuarioSelecionado = null;
let unsubscribeConversas = null; 

/* ====================================================
        REENVIAR PARA TODOS
==================================================== */
window.reenviarBoasVindas = () => {
    fetch(`${API_URL}/reenviar_boasvindas`, {
        method: "POST"
    })
    .then(r => r.json())
    .then(d => {
        if (d.status === "ok") {
            alert(`Reenviado para: ${d.reenviados.join(", ")}`);
        } else {
            alert(`Erro ao reenviar: ${JSON.stringify(d)}`);
        }
    })
    .catch((error) => alert(`Erro de conex√£o ao reenviar: ${error.message}`));
};

/* ====================================================
        LISTAR USU√ÅRIOS
==================================================== */
const lista = document.getElementById("listaUsuarios");

const qUsuarios = query(collection(db, "usuarios"), orderBy("criado", "desc"));

onSnapshot(qUsuarios, (snapshot) => {
    lista.innerHTML = "";
    snapshot.forEach((doc) => {
        const u = doc.data();
        lista.innerHTML += `
            <div onclick="selecionarUsuario('${u.numero}', '${u.nome || "Sem Nome"}')" 
                class="p-3 border-b border-gray-800 cursor-pointer hover:bg-gray-800">
                <div class="font-bold">${u.nome || "Sem Nome"}</div>
                <div class="text-gray-400 text-sm">${u.numero}</div>
            </div>
        `;
    });
});

/* ====================================================
        ABRIR CHAT DO USU√ÅRIO
==================================================== */
window.selecionarUsuario = (numero, nome) => {
    if (unsubscribeConversas) unsubscribeConversas();

    usuarioSelecionado = { numero, nome };

    document.getElementById("chatTitulo").innerText = `${nome} (${numero})`;
    document.getElementById("btnReenviarIndividual").classList.remove("hidden");

    const mensagensDiv = document.getElementById("mensagens");
    mensagensDiv.innerHTML = "";

    // üî• Consulta SIMPLIFICADA ‚Äî AGORA FUNCIONA!
    const q = query(
        collection(db, "conversas"),
        where("numero", "==", numero),
        orderBy("horario", "asc")
    );

    unsubscribeConversas = onSnapshot(q, (snapshot) => {
        mensagensDiv.innerHTML = "";

        snapshot.forEach((doc) => {
            const m = doc.data();
            mensagensDiv.innerHTML += `
                <div class="flex ${m.tipo === "enviada" ? "justify-end" : "justify-start"}">
                    <div class="message ${m.tipo === "enviada" ? "sent" : "received"}">
                        ${m.texto}
                    </div>
                </div>
            `;
        });

        mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
    }, (error) => {
        console.error("Erro ao carregar conversas:", error);
        alert("Erro ao carregar conversas. Verifique regras do Firebase.");
    });
};

/* ====================================================
        ENVIAR TEMPLATE
==================================================== */
window.reenviarParaUsuario = () => {
    if (!usuarioSelecionado) return;
    
    const payload = {
        numero: usuarioSelecionado.numero,
        template_name: "boas_vindas_7xx", 
        nome_usuario: usuarioSelecionado.nome 
    };

    fetch(`${API_URL}/enviar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(d => {
        alert(d.ok ? "Template enviado com sucesso!" : "Erro ao enviar template.");
    })
    .catch((error) => alert(`Erro: ${error.message}`));
};

/* ====================================================
        ENVIAR MENSAGEM NORMAL
==================================================== */
window.enviarMensagem = () => {
    const input = document.getElementById("inputMensagem");
    const texto = input.value.trim();

    if (!usuarioSelecionado) return alert("Selecione um usu√°rio primeiro.");
    if (!texto) return alert("Digite uma mensagem.");

    const payload = { numero: usuarioSelecionado.numero, texto: texto };

    fetch(`${API_URL}/enviar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(() => input.value = "")
    .catch((error) => alert(`Erro ao enviar mensagem: ${error.message}`));
};
</script>

</head>

<body>

<div class="flex">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="header font-bold text-xl">Usu√°rios</div>

        <button onclick="reenviarBoasVindas()" 
                class="w-full bg-green-600 py-2 mb-2 hover:bg-green-700 rounded">
            üîÑ Reenviar Boas-Vindas (Todos)
        </button>

        <div id="listaUsuarios"></div>
    </div>

    <!-- CHAT -->
    <div class="chat-area">

        <div class="header" id="chatTitulo">Selecione um usu√°rio</div>

        <button id="btnReenviarIndividual"
                onclick="reenviarParaUsuario()"
                class="bg-yellow-500 text-black px-4 py-1 m-2 rounded hover:bg-yellow-600 hidden">
            üîÅ Reenviar boas-vindas para este usu√°rio (Template)
        </button>

        <div id="mensagens" class="flex-1 p-4 overflow-y-auto"></div>

        <div class="p-4 border-t border-gray-800 flex">
            <input id="inputMensagem" type="text" placeholder="Digite uma mensagem..."
                class="flex-1 bg-gray-800 p-3 rounded-lg outline-none"
                onkeydown="if(event.key === 'Enter') enviarMensagem()">
            <button onclick="enviarMensagem()" 
                class="ml-3 bg-blue-600 px-5 rounded-lg hover:bg-blue-700">
                Enviar
            </button>
        </div>

    </div>
</div>

</body>
</html>
