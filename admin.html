<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin 7XX ‚Äì Painel Completo</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
    body {
        background: #0d0f12;
        color: #fff;
        font-family: Arial, sans-serif;
    }
    .sidebar {
        width: 320px;
        background: #111418;
        border-right: 1px solid #2a2f36;
        height: 100vh;
        overflow-y: auto;
    }
    .chat-area {
        flex: 1;
        background: #0f1217;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .message {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 10px;
        margin-bottom: 6px;
        font-size: 15px;
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .sent {
        background: #0b7dda;
        margin-left: auto;
    }
    .received {
        background: #1f242b;
        margin-right: auto;
    }
    .header {
        background: #14181d;
        padding: 16px;
        font-size: 18px;
        border-bottom: 1px solid #2a2f36;
    }

    .sidebar {
    width: 100%;
    max-width: 320px;
    background: #111418;
    border-right: 1px solid #2a2f36;
    height: 100vh;
    overflow-y: auto;
}

@media (max-width: 900px) {
    .sidebar {
        max-width: 200px;
        font-size: 12px;
    }

    .chat-area {
        font-size: 14px;
    }

    #inputMensagem {
        font-size: 14px;
        padding: 10px;
    }
}

@media (max-width: 600px) {
    .flex {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
        max-height: 300px;
    }

    .chat-area {
        height: calc(100vh - 300px);
    }
}

</style>

<script type="module">
/* ====================================================
        FIREBASE CONFIG
==================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
    getFirestore, collection, doc,
    query, where, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBod8YVf5pKWI98m9rRR8axokDkNMlXX-k",
    authDomain: "aviatordaniel100x.firebaseapp.com",
    databaseURL: "https://aviatordaniel100x-default-rtdb.firebaseio.com",
    projectId: "aviatordaniel100x",
    storageBucket: "aviatordaniel100x.firebasestorage.app",
    messagingSenderId: "169015417803",
    appId: "1:169015417803:web:ce4aa4f9b77d5ddb07344e",
    measurementId: "G-EES9SVSV72"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ====================================================
        VARI√ÅVEIS
==================================================== */
let usuarioSelecionado = null;

/* ====================================================
        REENVIAR PARA TODOS
==================================================== */
window.reenviarBoasVindas = () => {
    fetch("https://daniel100x.onrender.com/reenviar_boasvindas", {
        method: "POST"
    })
    .then(r => r.json())
    .then(d => alert("Reenviado para: " + d.reenviados.join(", ")))
    .catch(() => alert("Erro ao reenviar mensagens"));
};

/* ====================================================
        LISTAR USU√ÅRIOS
==================================================== */
const lista = document.getElementById("listaUsuarios");

const qUsuarios = query(collection(db, "usuarios"), orderBy("criado", "desc"));

onSnapshot(qUsuarios, (snapshot) => {
    lista.innerHTML = "";
    snapshot.forEach((doc) => {
        const u = doc.data();
        lista.innerHTML += `
            <div onclick="selecionarUsuario('${u.numero}', '${u.nome || "Sem Nome"}')" 
                class="p-3 border-b border-gray-800 cursor-pointer hover:bg-gray-800">
                <div class="font-bold">${u.nome || "Sem nome"}</div>
                <div class="text-gray-400 text-sm">${u.numero}</div>
            </div>
        `;
    });
});

/* ====================================================
        ABRIR CHAT DO USU√ÅRIO
==================================================== */
window.selecionarUsuario = (numero, nome) => {
    usuarioSelecionado = { numero, nome };

    document.getElementById("chatTitulo").innerText = nome + " (" + numero + ")";
    document.getElementById("btnReenviarIndividual").classList.remove("hidden");

    const mensagensDiv = document.getElementById("mensagens");
    mensagensDiv.innerHTML = "";

    const q = query(
        collection(db, "conversas"),
        where("numero", "==", numero),
        orderBy("horario", "asc")
    );

    onSnapshot(q, (snapshot) => {
        mensagensDiv.innerHTML = "";

        snapshot.forEach((doc) => {
            const m = doc.data();

            mensagensDiv.innerHTML += `
                <div class="message ${m.tipo === "enviada" ? "sent" : "received"}">
                    ${m.texto}
                </div>
            `;
        });

        mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
    });
};

/* ====================================================
        ENVIAR BOAS-VINDAS INDIVIDUAL
==================================================== */
window.reenviarParaUsuario = () => {
    if (!usuarioSelecionado) return;

    fetch("https://daniel100x.onrender.com/boasvindas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            nome: usuarioSelecionado.nome,
            numero: usuarioSelecionado.numero
        })
    })
    .then(() => alert("Boas-vindas enviada novamente!"))
    .catch(() => alert("Erro ao enviar!"));
};

/* ====================================================
        ENVIAR MENSAGEM NORMAL
==================================================== */
window.enviarMensagem = () => {
    const input = document.getElementById("inputMensagem");
    const texto = input.value.trim();

    if (!texto || !usuarioSelecionado) return;

    fetch("https://daniel100x.onrender.com/enviar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            numero: usuarioSelecionado.numero,
            texto: texto
        })
    });

    input.value = "";
};
</script>

</head>

<body>

<div class="flex">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="header font-bold text-xl">Usu√°rios</div>

        <!-- üî• BOT√ÉO: REENVIAR PARA TODOS -->
        <button onclick="reenviarBoasVindas()" 
                class="w-full bg-green-600 py-2 mb-2 hover:bg-green-700 rounded">
            üîÑ Reenviar Boas-Vindas (Todos)
        </button>

        <div id="listaUsuarios"></div>
    </div>

    <!-- √ÅREA DO CHAT -->
    <div class="chat-area">

        <div class="header" id="chatTitulo">Selecione um usu√°rio</div>

        <!-- üî• BOT√ÉO: REENVIAR INDIVIDUAL -->
        <button id="btnReenviarIndividual"
                onclick="reenviarParaUsuario()"
                class="bg-yellow-500 text-black px-4 py-1 m-2 rounded hover:bg-yellow-600 hidden">
            üîÅ Reenviar boas-vindas para este usu√°rio
        </button>

        <!-- MENSAGENS -->
        <div id="mensagens" class="flex-1 p-4 overflow-y-auto"></div>

        <!-- INPUT -->
        <div class="p-4 border-t border-gray-800 flex">
            <input id="inputMensagem" type="text" placeholder="Digite uma mensagem..."
                class="flex-1 bg-gray-800 p-3 rounded-lg outline-none">
            <button onclick="enviarMensagem()" 
                class="ml-3 bg-blue-600 px-5 rounded-lg hover:bg-blue-700">
                Enviar
            </button>
        </div>

    </div>
</div>

</body>
</html>
