# ============================================================
# üîÆ M√ìDULO DE PREVIS√ïES (cerebro_ia.py)
# VERS√ÉO FINAL: Compat√≠vel com o Dashboard atual sem mexer no HTML
# ============================================================
import random
from firebase_admin import firestore
from firebase_admin.firestore import client as firestore_client

class CerebroIA:
    def __init__(self, db_client: firestore_client):
        """Inicializa a IA com conex√£o ao banco de dados."""
        self.db = db_client
        self.historico = []  

        # --- Vari√°veis de Monitoramento ---
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.padrao_atual = ""
        self.sinal_ativo_doc_id = None 
        self.colecao_ativa = "" 
        self.LIMITE_SINAIS_MANTER = 4

        # Limpeza de seguran√ßa ao iniciar
        self._limpar_sinais_inicio()

    def processar_vela(self, valor, cor):
        """Fun√ß√£o principal: recebe cada nova vela do jogo."""
        cor_tratada = str(cor).lower().strip()

        self.historico.append({'valor': valor, 'cor': cor_tratada})
        if len(self.historico) > 10:
            self.historico.pop(0)

        # 1. Se estamos monitorando, verifica o resultado
        if self.monitorando:
            self._verificar_resultado(valor)
            return

        # 2. Se n√£o, busca novos padr√µes
        self._buscar_padroes()

    # ============================================================
# üîÆ M√ìDULO DE PREVIS√ïES (cerebro_ia.py)
# VERS√ÉO FINAL CORRIGIDA: Matem√°tica exata (Green sobe Green, Red sobe Red)
# ============================================================
import random
from firebase_admin import firestore
from firebase_admin.firestore import client as firestore_client

class CerebroIA:
    def __init__(self, db_client: firestore_client):
        """Inicializa a IA com conex√£o ao banco de dados."""
        self.db = db_client
        self.historico = []   

        # --- Vari√°veis de Monitoramento ---
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.padrao_atual = ""
        self.sinal_ativo_doc_id = None 
        self.colecao_ativa = "" 
        self.LIMITE_SINAIS_MANTER = 4

        # Limpeza de seguran√ßa ao iniciar
        self._limpar_sinais_inicio()

    def processar_vela(self, valor, cor):
        """Fun√ß√£o principal: recebe cada nova vela do jogo."""
        cor_tratada = str(cor).lower().strip()

        self.historico.append({'valor': valor, 'cor': cor_tratada})
        if len(self.historico) > 10:
            self.historico.pop(0)

        # 1. Se estamos monitorando, verifica o resultado
        if self.monitorando:
            self._verificar_resultado(valor)
            return

        # 2. Se n√£o, busca novos padr√µes
        self._buscar_padroes()

    # ============================================================
# üîÆ M√ìDULO DE PREVIS√ïES (cerebro_ia.py)
# VERS√ÉO FINAL: Caminho alinhado com seu JavaScript + Matem√°tica Fixada
# ============================================================
import random
from firebase_admin import firestore
from firebase_admin.firestore import client as firestore_client

class CerebroIA:
    def __init__(self, db_client: firestore_client):
        """Inicializa a IA com conex√£o ao banco de dados."""
        self.db = db_client
        self.historico = []   

        # --- Vari√°veis de Monitoramento ---
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.padrao_atual = ""
        self.sinal_ativo_doc_id = None 
        self.colecao_ativa = "" 
        self.LIMITE_SINAIS_MANTER = 4

        # Limpeza de seguran√ßa ao iniciar
        self._limpar_sinais_inicio()

    def processar_vela(self, valor, cor):
        """Fun√ß√£o principal: recebe cada nova vela do jogo."""
        cor_tratada = str(cor).lower().strip()

        self.historico.append({'valor': valor, 'cor': cor_tratada})
        if len(self.historico) > 10:
            self.historico.pop(0)

        # 1. Se estamos monitorando, verifica o resultado
        if self.monitorando:
            self._verificar_resultado(valor)
            return

        # 2. Se n√£o, busca novos padr√µes
        self._buscar_padroes()

    # ================================================================
    # VERIFICA RESULTADO (GREEN / RED) - MATEM√ÅTICA CORRIGIDA
    # ================================================================
    def _verificar_resultado(self, valor):
        self.contador_pos_sinal += 1
        
        # --- CEN√ÅRIO 1: GREEN (VIT√ìRIA) ---
        if valor >= 2.00:
            tipo_vela = "ROSA üå∏" if valor >= 10 else "ROXA üü£"
            print(f"üü© [IA] GREEN! {valor}x ({tipo_vela}) - Salvando estat√≠sticas...")

            try:
                doc_ref = self.db.collection("assertividade").document("dado")
                try:
                    # Sobe APENAS Green e Total
                    doc_ref.update({
                        "greens": firestore.Increment(1),
                        "total": firestore.Increment(1)
                    })
                except:
                    doc_ref.set({"greens": 1, "reds": 0, "total": 1})
                
                print("‚úÖ [IA] Estat√≠stica GREEN salva.")
            except Exception as e:
                print(f"‚ùå [IA] Erro no banco: {e}")

            self._deletar_sinal_ativo()
            return

        # --- CEN√ÅRIO 2: CONTINUA MONITORANDO (GALE) ---
        if self.contador_pos_sinal < self.LIMITE_SINAIS_MANTER:
            print(f"‚ö†Ô∏è [IA] Gale {self.contador_pos_sinal}... Aguardando.")
            return

        # --- CEN√ÅRIO 3: RED (DERROTA) ---
        print(f"üü• [IA] RED! O padr√£o {self.padrao_atual} falhou.")
        
        try:
            doc_ref = self.db.collection("assertividade").document("dado")
            try:
                # Sobe APENAS Red e Total
                doc_ref.update({
                    "reds": firestore.Increment(1),
                    "total": firestore.Increment(1)
                })
            except:
                doc_ref.set({"greens": 0, "reds": 1, "total": 1})

            print("üìâ [IA] Estat√≠stica RED salva.")
        except Exception as e:
            print(f"‚ùå [IA] Erro no banco: {e}")

        self._deletar_sinal_ativo()


    def _buscar_padroes(self):
        """Analisa o hist√≥rico e direciona para a cole√ß√£o correta."""
        if len(self.historico) < 3:
            return

        ultimas_3_cores = [h['cor'] for h in self.historico[-3:]]
        penultima_vela = self.historico[-2]['valor']
        ultima_vela = self.historico[-1]['valor']

        # PADR√ÉO 1: 3 Azuis -> CAMINHO EXATO DO SEU JAVASCRIPT
        if ultimas_3_cores == ["azul", "azul", "azul"]:
            print(f"üíé [IA] Padr√£o 3 Azuis -> Enviando para Subcole√ß√£o")
            self._disparar_sinal_monitorado(
                nome_padrao="sequencia_3_azuis",
                caminho_colecao="analises/sequencia_3_azuis/sinais" # <--- VOLTEI O CAMINHO CORRETO
            )
            return

        # PADR√ÉO 2: Risco
        if penultima_vela < 1.20 and ultima_vela < 1.20:
            print(f"üìâ [IA] Padr√£o Risco -> Enviando para 'sinais_risco'")
            self._disparar_sinal_monitorado(
                nome_padrao="duas_velas_abaixo_1_20",
                caminho_colecao="sinais_risco"
            )
            return

    def _disparar_sinal_monitorado(self, nome_padrao, caminho_colecao):
        if self.monitorando:
            return 

        print(f"üöÄ [IA] Gerando sinal em: {caminho_colecao}...")
        try:
            v1 = float("{:.2f}".format(random.uniform(2.00, 9.99)))
            v2 = float("{:.2f}".format(random.uniform(10.00, 20.00)))
            v3 = float("{:.2f}".format(random.uniform(21.00, 100.00)))

            doc_ref = self.db.collection(caminho_colecao).document()
            doc_ref.set({
                "valores": [v1, v2, v3],
                "padrao": nome_padrao,
                "criado": firestore.SERVER_TIMESTAMP,
                "status": "ATIVO"
            })

            self.sinal_ativo_doc_id = doc_ref.id
            self.colecao_ativa = caminho_colecao
            self.monitorando = True
            self.padrao_atual = nome_padrao
            self.contador_pos_sinal = 0

            print(f"üö© [IA] Sinal ID: {self.sinal_ativo_doc_id} postado.")

        except Exception as e:
            print(f"‚ùå [IA] Erro ao enviar sinal: {e}")

    # =====================================================================
    # REMOVE O SINAL
    # =====================================================================
    def _deletar_sinal_ativo(self):
        print("üóëÔ∏è [IA] Removendo sinal ativo...")

        try:
            # Tenta deletar usando o caminho salvo na cria√ß√£o
            if self.sinal_ativo_doc_id and self.colecao_ativa:
                ref = self.db.collection(self.colecao_ativa).document(self.sinal_ativo_doc_id)
                ref.delete()
                print(f"üóëÔ∏è [IA] Sinal removido de {self.colecao_ativa}.")

        except Exception as e:
            print(f"‚ö†Ô∏è [IA] Falha ao remover ID direto: {e}")
            print("üîÑ [IA] Tentando varredura geral...")
            try:
                # Varredura na pasta profunda (JavaScript)
                docs = self.db.collection("analises/sequencia_3_azuis/sinais").order_by("criado", direction=firestore.Query.DESCENDING).limit(1).stream()
                for d in docs: d.reference.delete()
                
                # Varredura na pasta risco
                docs2 = self.db.collection("sinais_risco").order_by("criado", direction=firestore.Query.DESCENDING).limit(1).stream()
                for d in docs2: d.reference.delete()
                
                print("üßπ [IA] Varredura completa.")
            except:
                pass

        self.sinal_ativo_doc_id = None
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.colecao_ativa = ""


    def _limpar_sinais_inicio(self):
        """Limpa as pastas ao iniciar."""
        try:
            batch = self.db.batch()
            c = 0
            
            # Limpa risco
            for d in self.db.collection("sinais_risco").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            # Limpa a subcole√ß√£o profunda (JavaScript)
            for d in self.db.collection("analises/sequencia_3_azuis/sinais").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            if c > 0:
                batch.commit()

            print("üßπ [IA] Limpeza inicial completa.")

        except Exception as e:
            print("‚ö†Ô∏è Erro ao limpar sinais:", e)
    # =====================================================================
    # REMOVE O SINAL (FUN√á√ÉO MAIS IMPORTANTE)
    # =====================================================================
    def _deletar_sinal_ativo(self):
        print("üóëÔ∏è [IA] Tentando remover sinal ativo...")

        try:
            # --- PREVIS√ÉO IA ---
            if self.colecao_ativa == "analises/sequencia_3_azuis/sinais":
                ref = (
                    self.db.collection("analises")
                    .document("sequencia_3_azuis")
                    .collection("sinais")
                    .document(self.sinal_ativo_doc_id)
                )
                ref.delete()
                print("üóëÔ∏è [IA] Previs√£o IA removida.")

            # --- SINAL DE RISCO ---
            else:
                ref = self.db.collection("sinais_risco").document(self.sinal_ativo_doc_id)
                ref.delete()
                print("üóëÔ∏è [IA] Sinal de risco removido.")

        except Exception as e:
            print(f"‚ö†Ô∏è [IA] Falha ao remover pelo ID: {e}")
            print("üîÑ [IA] Iniciando VARREDURA...")

            try:
                if self.colecao_ativa == "analises/sequencia_3_azuis/sinais":
                    ref = (
                        self.db.collection("analises")
                        .document("sequencia_3_azuis")
                        .collection("sinais")
                    )
                else:
                    ref = self.db.collection("sinais_risco")

                docs = (
                    ref.order_by("criado", direction=firestore.Query.DESCENDING)
                    .limit(1)
                    .stream()
                )

                for d in docs:
                    d.reference.delete()
                    print("üßπ [IA] Varredura completa: sinal removido.")

            except Exception as e2:
                print(f"‚ùå [IA] Falha total ao remover: {e2}")

        # RESET TOTAL
        self.sinal_ativo_doc_id = None
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.colecao_ativa = ""


    def _limpar_sinais_inicio(self):
        """Limpa as duas pastas ao iniciar."""
        try:
            batch = self.db.batch()
            c = 0

            for d in self.db.collection("sinais_risco").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            for d in self.db.collection("analises/sequencia_3_azuis/sinais").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            if c > 0:
                batch.commit()

            print("üßπ [IA] Limpeza inicial completa.")

        except Exception as e:
            print("‚ö†Ô∏è Erro ao limpar sinais:", e)

           # =====================================================================
    # REMOVE O SINAL (FUN√á√ÉO MAIS IMPORTANTE)
    # =====================================================================
    def _deletar_sinal_ativo(self):
        print("üóëÔ∏è [IA] Tentando remover sinal ativo...")

        try:
            # --- PREVIS√ÉO IA ---
            if self.colecao_ativa == "analises/sequencia_3_azuis/sinais":
                ref = (
                    self.db.collection("analises")
                    .document("sequencia_3_azuis")
                    .collection("sinais")
                    .document(self.sinal_ativo_doc_id)
                )
                ref.delete()
                print("üóëÔ∏è [IA] Previs√£o IA removida.")

            # --- SINAL DE RISCO ---
            else:
                ref = self.db.collection("sinais_risco").document(self.sinal_ativo_doc_id)
                ref.delete()
                print("üóëÔ∏è [IA] Sinal de risco removido.")

        except Exception as e:
            print(f"‚ö†Ô∏è [IA] Falha ao remover pelo ID: {e}")
            print("üîÑ [IA] Iniciando VARREDURA...")

            try:
                if self.colecao_ativa == "analises/sequencia_3_azuis/sinais":
                    ref = (
                        self.db.collection("analises")
                        .document("sequencia_3_azuis")
                        .collection("sinais")
                    )
                else:
                    ref = self.db.collection("sinais_risco")

                docs = (
                    ref.order_by("criado", direction=firestore.Query.DESCENDING)
                    .limit(1)
                    .stream()
                )

                for d in docs:
                    d.reference.delete()
                    print("üßπ [IA] Varredura completa: sinal removido.")

            except Exception as e2:
                print(f"‚ùå [IA] Falha total ao remover: {e2}")

        # RESET TOTAL
        self.sinal_ativo_doc_id = None
        self.monitorando = False
        self.contador_pos_sinal = 0
        self.colecao_ativa = ""



    def _limpar_sinais_inicio(self):
        """Limpa as duas pastas ao iniciar."""
        try:
            batch = self.db.batch()
            c = 0

            for d in self.db.collection("sinais_risco").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            for d in self.db.collection("analises/sequencia_3_azuis/sinais").limit(5).stream():
                batch.delete(d.reference)
                c += 1

            if c > 0:
                batch.commit()

            print("üßπ [IA] Limpeza inicial completa.")

        except Exception as e:
            print("‚ö†Ô∏è Erro ao limpar sinais:", e)
